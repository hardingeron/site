from PIL import Image
from PIL.ExifTags import TAGS
from models import Purcell
import os
from sqlalchemy import func, desc



from PIL import Image
from PIL.ExifTags import TAGS
from sqlalchemy import func
from models import Purcell, Booking, Storage




#===========================================================================================================================================================
#-------------------------- Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /add
#===========================================================================================================================================================

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
def get_last_record(selected_date, db): 
    last_record = db.session.query(Purcell).filter(Purcell.flight == selected_date).order_by(Purcell.number.desc()).first()
    if last_record:
        number = last_record.number
    else:
        number = 1
    return number

def generate_new_number(date, number):
    while True:
        existing_record = Purcell.query.filter_by(number=int(number), flight=date).first()
        if existing_record is None:
            break
        number += 1
    return number


# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸
def calculate_cost(payment_type, cost_amount, currency):
    if payment_type == 'paid':
        cost = f"+ {cost_amount} {currency}"
    elif payment_type == 'not_paid':
        cost = f"- {cost_amount} {currency}"
    else:
        cost = f"+ {cost_amount} {currency}ðŸ’³"
    return cost

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
def add_record(last, form_data, cost, db, user_role):
    date = form_data['date']
    
    try:
        add = Purcell(
            sender=form_data['sender'].upper(),
            sender_phone=form_data['sender_phone'],
            recipient=form_data['recipient'].upper(),
            recipient_phone=form_data['recipient_phone'],
            inventory=form_data['inventory'].replace('\n', ' ').replace('\r', ' '),
            cost=cost,
            passport=form_data['passport'],
            weight=form_data['weight'].upper(),
            responsibility=form_data['responsibility'].upper(),
            number=last,
            city=form_data['city'],
            flight=date,
            image=f"static/purcells/{last}-{date}.jpeg",
            where_from=user_role
        )
        
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² ÑÐµÑÑÐ¸ÑŽ Ð¸ Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        db.session.add(add)
        db.session.commit()
        
        return last
    except Exception as e:
        # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
        return f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸: {str(e)}"


# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
def handle_image(file, number, flight, app):
    filename = f"{number}-{flight}.jpeg"
    image_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
    file.save(image_path)
    
    # ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Pillow
    image = Image.open(image_path)
    image_exif = image._getexif()
    
    # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ€Ð¸ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
    if image_exif is not None:
        for tag, value in image_exif.items():
            if TAGS.get(tag) == 'Orientation':
                if value == 3:
                    image = image.rotate(180, expand=True)
                elif value == 6:
                    image = image.rotate(270, expand=True)
                elif value == 8:
                    image = image.rotate(90, expand=True)
    
    # Ð¡Ð¶Ð¸Ð¼Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ñ Ð·Ð°Ð´Ð°Ð½Ð½Ñ‹Ð¼ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼
    compress_quality = 50
    image.save(image_path, 'JPEG', quality=compress_quality)

#===========================================================================================================================================================
#-------------------------- Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /add >----> ÐºÐ¾Ð½ÐµÑ† <----< ---------------------------------------------------------------
#===========================================================================================================================================================



#===========================================================================================================================================================
#-------------------------- Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /change
#===========================================================================================================================================================
def handle_uploaded_image(file, number, flight, app):
    # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð¸ Ñ€ÐµÐ¹ÑÐ°
    filename = f"{number}-{flight}.jpeg"
    
    # ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð´Ð¾ Ð¼ÐµÑÑ‚Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
    image_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)

    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð½Ð° Ð´Ð¸ÑÐº
    file.save(image_path)

    # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ´ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼
    process_image(image_path)


def process_image(image_path):
    # ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ PIL
    image = Image.open(image_path)
    
    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ… (EXIF) Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
    image_exif = image._getexif()
    
    if image_exif is not None:
        # ÐŸÐ¾Ð²Ð¾Ñ€Ð¾Ñ‚ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ Ð¾Ñ€Ð¸ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÐµÐ¹ Ð¸Ð· Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ñ…
        for tag, value in image_exif.items():
            if TAGS.get(tag) == 'Orientation':
                if value == 3:
                    image = image.rotate(180, expand=True)
                elif value == 6:
                    image = image.rotate(270, expand=True)
                elif value == 8:
                    image = image.rotate(90, expand=True)

    # ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ¶Ð°Ñ‚Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ (Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ 0 Ð´Ð¾ 100)
    compress_quality = 75  # Ð—Ð°Ð´Ð°Ð¹Ñ‚Ðµ Ð¶ÐµÐ»Ð°ÐµÐ¼Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐ¶Ð°Ñ‚Ð¸Ñ
    
    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ JPEG
    image.save(image_path, 'JPEG', quality=compress_quality)

#===========================================================================================================================================================
#                                               Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /change >----> ÐºÐ¾Ð½ÐµÑ† <----< 
#===========================================================================================================================================================



#===========================================================================================================================================================
#                                                Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /reservation /reservation_big
#===========================================================================================================================================================
def get_reservation_data(selected_date, reis, bus):
    data = Booking.query.filter_by(data=selected_date, fwc=reis).all()
    number_of_records = len(data)
    number_of_free_records = bus - number_of_records

    sum_gel = 0
    sum_rub = 0
    sum_usd = 0
    sum_eur = 0
    sum_card_gel = 0
    sum_card_rub = 0
    sum_card_usd = 0
    sum_card_eur = 0
    male_count = 0
    female_count = 0
    came_count = 0

    for person in data:
        if person.gender == 'male':
            male_count += 1
        elif person.gender == 'female':
            female_count += 1
    
    for came in data:
        if came.action == 'yes':
            came_count += 1

    came_of_count_free = number_of_records - came_count

    for booking in data:
        payment_value = booking.payment
        
        if payment_value.startswith('+'):
            payment_value = payment_value[1:]  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð¼Ð²Ð¾Ð» "+"
            
            if payment_value.endswith('GEL'):
                sum_gel += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "GEL" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('RUB'):
                sum_rub += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "RUB" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('USD'):
                sum_usd += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "USD" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('EUR'):
                sum_eur += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "EUR" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾

        elif payment_value.startswith('C'):
            payment_value = payment_value[1:]  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð¼Ð²Ð¾Ð» "C"
            
            if payment_value.endswith('GEL'):
                sum_card_gel += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "GEL" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('RUB'):
                sum_card_rub += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "RUB" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('USD'):
                sum_card_usd += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "USD" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾
            elif payment_value.endswith('EUR'):
                sum_card_eur += float(payment_value[:-3])  # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ "EUR" Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² Ñ‡Ð¸ÑÐ»Ð¾

    seat_data = {}

    for booking in data:
        seat_data[booking.position] = {
            'name': booking.flname,
            'phone': booking.phone,
            'payment': booking.payment,
            'gender': booking.gender,
            'pasport': booking.pasport,
            'comment': booking.comment,
            'destination': booking.destination,
            'reis': booking.data,
            'action': booking.action

        }

    return {
        'seat_data': seat_data,
        'd': selected_date,
        'reis': reis,
        'number_of_records': number_of_records,
        'number_of_free_records': number_of_free_records,
        'sum_gel': sum_gel,
        'sum_rub': sum_rub,
        'sum_usd': sum_usd,
        'sum_eur': sum_eur,
        'sum_card_gel': sum_card_gel,
        'sum_card_rub': sum_card_rub,
        'sum_card_usd': sum_card_usd,
        'sum_card_eur': sum_card_eur,
        'male_count': male_count,
        'female_count': female_count,
        'came_count': came_count,
        'came_of_count_free': came_of_count_free
    }






#===========================================================================================================================================================
#-------------------------- Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /reservation /reservation_big >----> ÐºÐ¾Ð½ÐµÑ† <----< ---------------------------------------------------------------
#===========================================================================================================================================================



#===========================================================================================================================================================
#                                                Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /storage   /add
#===========================================================================================================================================================


def validate_input(shelf, trecing):
    return bool(shelf) and bool(trecing)


def format_trecing(trecing):
    if not trecing.startswith(('mp', 'MP')):
        trecing = f'MP{trecing}'
    else:
        trecing = trecing.upper()
    return trecing


def save_record(shelf, trecing, date, db):
    existing_record = Storage.query.filter_by(trecing=trecing).first()
    if existing_record:
        existing_record.shelf = shelf
    else:
        record = Storage(shelf=shelf, trecing=trecing, date=date)
        db.session.add(record)
    db.session.commit()
    return shelf


#===========================================================================================================================================================
#-------------------------- Ð”Ð›Ð¯ ÐžÐ‘Ð ÐÐ‘ÐžÐ¢Ð§Ð˜ÐšÐ /storage /add >----> ÐºÐ¾Ð½ÐµÑ† <----< ---------------------------------------------------------------
#===========================================================================================================================================================
